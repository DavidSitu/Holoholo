#include <opencv2/opencv.hpp>
#include <pcl/io/pcd_io.h>
#include <pcl/visualization/pcl_visualizer.h>
#include <pcl/visualization/cloud_viewer.h>

int main(int argc, char** argv) {
  // Load input images
  std::vector<cv::Mat> images;
  for (int i = 0; i < argc; i++) {
    cv::Mat img = cv::imread(argv[i], cv::IMREAD_COLOR);
    if (!img.empty()) {
      images.push_back(img);
    }
  }
  
  cv::Ptr<cv::Feature2D> feature_detector = cv::ORB::create();
  cv::Ptr<cv::DescriptorMatcher> descriptor_matcher = cv::DescriptorMatcher::create("BruteForce-Hamming");
  std::vector<cv::KeyPoint> keypoints;
  cv::Mat descriptors;
  feature_detector->detect(images, keypoints);
  descriptor_matcher->match(images, descriptors);
  pcl::PointCloud<pcl::PointXYZ>::Ptr point_cloud(new pcl::PointCloud<pcl::PointXYZ>);
  for (int i = 0; i < images.size(); i++) {
    cv::Mat camera_matrix, distortion_coefficients;
    std::vector<cv::Point3d> object_points;
    std::vector<cv::Point2d> image_points;
    cv::Mat rvec, tvec;
    cv::solvePnP(object_points, image_points, camera_matrix, distortion_coefficients, rvec, tvec);

    cv::Matx34d proj_matrix(rvec, tvec);
    cv::Matx31d homogeneous_point;
    cv::triangulatePoints(cv::Matx33d::eye(), cv::Matx34d::zeros(), cv::Matx33d::eye(), proj_matrix, keypoints, homogeneous_point);
    cv::Matx31d point(homogeneous_point(0) / homogeneous_point(3), homogeneous_point(1) / homogeneous_point(3), homogeneous_point(2) / homogeneous_point(3));
    point_cloud->push_back(pcl::PointXYZ(point(0), point(1), point(2)));
  }

  pcl::visualization::PCLVisualizer viewer("3D Model");
  viewer.addPointCloud(point_cloud);
  viewer.spin();

  return 0;
}
